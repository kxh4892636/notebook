---
id: 5b6fa40c-5ead-4e08-afa2-5a9ae77f55a1
---

# 网络请求和远程资源

## XMLHttpRequest 对象

### 使用 XHR

```typescript
// 定义 XHR 对象
// 三个参数依次为请求类型, URL, 是否异步
xhr.open("get", "example.php", false);

// 发送请求
xhr.send(null);

// 返回请求
// responseText: 响应体返回文本
// responseXML: XML DOM 文档
// status: HTTP 状态
// statusText: HTTP 状态描述
if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
  alert(xhr.responseText);
} else {
  alert("Request was unsuccessful: " + xhr.status);
}

// 异步处理
let xhr = new XMLHttpRequest();
xhr.onreadystatechange = function () {
  // readyState 属性
  // 0: 未初始化, 1: 已调用 open(), 2: 已调用 send(), 3: 接收部分响应, 4: 接收所有响应.
  if (xhr.readyState == 4) {
    if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
      alert(xhr.responseText);
    } else {
      alert("Request was unsuccessful: " + xhr.status);
    }
  }
};
xhr.open("get", "example.txt", true);
xhr.send(null);

// 取消请求
xhr.abort();
```

### HTTP 头部

**XHR 头部字段**

| 头部字段        | 描述           |
| --------------- | -------------- |
| Accept          | 内容类型       |
| Accept-Charset  | 字符集         |
| Accept-Encoding | 编码类型       |
| Accept-Language | 语言           |
| Connection      | 连接类型       |
| Cookie          | cookie         |
| Host            | 页面所在域     |
| Referer         | 页面 URL       |
| User-Agent      | 用户代理字符串 |

**操作头部字段**

```typescript
// 设置头部字段
xhr.open("get", "example.php", true);
xhr.setRequestHeader("MyHeader", "MyValue");
xhr.send(null);
// 获得头部字段
let myHeader = xhr.getResponseHeader("MyHeader"); // 指定字段
let allHeaders xhr.getAllResponseHeaders(); // 所有字段
```

### get 请求

```typescript
// key-value 使用 encodeURIComponent() 编码
xhr.open("get", "example.php?name1=value1&name2=value2", true);
```

### post 请求

```typescript
xhr.open("post", "postexample.php", true);
xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
let form = document.getElementById("user-info");
xhr.send(serialize(form)); // 发送序列化后的表单数据
```

### XMLHttpRequest Level 2

**FormData 类型**

```typescript
// 便于表单序列化
let data = new FormData();
data.append("name", "Nicholas");
// 直接序列化表单元素
let data = new FormData(document.forms[0]);
// 用于 send() 方法, 不需要显式设置头部
xhr.open("post", "postexample.php", true);
let form = document.getElementById("user-info");
xhr.send(new FormData(form));
```

**超时**

```typescript
// 超时后触发 timeout 事件
xhr.open("get", "timeout.php", true);
xhr.timeout = 1000; // 设置 1 秒超时
xhr.ontimeout = function () {
  alert("Request did not return in a second.");
};
xhr.send(null);
```

**overrideMimeType()方法**

```typescript
// 覆写 XHR 响应的 MIME 类型
// send() 调用前使用
let xhr = new XMLHttpRequest();
xhr.open("get", "text.php", true);
xhr.overrideMimeType("text/xml");
xhr.send(null);
```

## 进度事件

### 基本概念

**相关事件**

| 事件      | 触发时机                   |
| --------- | -------------------------- |
| loadstart | 接受到响应的第一个字节触发 |
| progress  | 接受响应期间反复触发       |
| error     | 请求出错触发               |
| abort     | 调用 abort() 触发          |
| load      | 成功接受响应后触发         |
| loadend   | error/abort/load 之后触发  |

### load 事件

```typescript
// load 事件接受 event 对象
// target 属性为 XHR 示例;
let xhr = new XMLHttpRequest();
xhr.onload = function (event) {
  console.log(event);
};
xhr.open("get", "altevents.php", true);
xhr.send(null);
```

### progress 事件

```typescript
// progress 事件接受 event 对象
// target 属性为 XHR 示例, 具有 lengthComputable, position, totalSize 三个属性, 依次为进度信息是否可用(布尔值), 收到字节数, 总字节数
let xhr = new XMLHttpRequest();
xhr.onprogress = function (event) {
  let divStatus = document.getElementById("status");
  if (event.lengthComputable) {
    divStatus.innerHTML =
      "Received " + event.position + " of " + event.totalSize + " bytes";
  } else;
};
xhr.open("get", "altevents.php", true);
xhr.send(null);
```

## 跨源资源共享

### 基本概念

**cors**

- 默认情况下 XHR 只能请求同域内的资源;
- cors 定义了浏览器和服务器如何实现跨源通信;

```json
// 浏览器定义 origin 头部
Origin: http://www.nczonline.net
// 服务器发送对应 Access-Control-Allow-Origin 头部
Access-Control-Allow-Origin: http://www.nczonline.net
```

```typescript
// 使用绝对 URL, 自动设置 origin 头部
xhr.open("get", "http://www.somewhere-else.com/page/", true);
xhr.send(null);
```

### 预检请求

**预检请求**

```json
// cors 服务器验证机制
// 浏览器使用 options 方法发送一下头部
Origin: http://www.nczonline.net // URL
Access-Control-Request-Method: POST // 请求方法
Access-Control-Request-Headers: NCZ // 自定义头部
// 服务器响应中发送头部
Access-Control-Allow-Origin: http://www.nczonline.net // URL
Access-Control-Allow-Methods: POST, GET // 允许方法
Access-Control-Allow-Headers: NCZ // 允许自定义头部
Access-Control-Max-Age: 1728000 // 缓存秒数
```

### 凭证请求

```json
// 浏览器设置 withCredentials 属性为 true
// 服务器响应发送以下头部
Access-Control-Allow-Credentials: true
```

### 替代性跨源技术

**替代性跨源技术**

- 图片探测;
- JSONP;

## SSE

### 基础

**SSE**

- 服务器推送;
- 单向通道;

### 数据格式

**字符编码**

- UTF-8;

**message**

```json
# 一次信息有若干 message 组成
# 使用 : 表示注释
# message 之间 \n\n 间隔
# 单个 message 使用 \n 跨行
: this is a test stream\n\n

data: some text\n\n

data: another message\n
data: with two lines \n\n
```

**字段**

```json
# data 表示数据内容
data: begin message\n
data: continue message\n\n

# id 字段表示标识符, 用于重连机制
id: msg1\n
data: message\n\n

# event 字段表示自定义事件, 默认为 message
event: foo\n
data: a foo event\n\n

event: bar\n
data: a bar event\n\n

data: an unnamed event\n\n

# retry 字段指定浏览器重连时间间隔
retry: 10000\n
```

### 客户端

```typescript
// 建立 EventSource 对象
const source = new EventSource(url); // 只能是 get 请求
// 链接建立, 触发 open 事件
source.addEventListener(
  "open",
  (event) => {
    //...
  },
  false
);
// 服务器返回信息, 触发 message 事件
source.addEventListener(
  "message",
  (event) => {
    const data = event.data;
    // ...
  },
  false
);
// 链接出错, 触发 error 事件
source.addEventListener(
  "error",
  (event) => {
    // ...
  },
  false
);
// 关闭 EventSource 对象
source.close();
```

### 服务端

```typescript
// 设置 http 头
res.setHeader("Content-Type", "text/event-stream");
res.setHeader("Cache-Control", "no-cache");
// 发送数据
res.write(
  `data:  ${JSON.stringify({
    status: "success",
    content: [datasetID, modelID, [uvID]],
  })}\n\n`
);
```
